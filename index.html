<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Micro Insurance</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        
        /* Brave-specific fixes */
        button { -webkit-appearance: none; appearance: none; }
        input { -webkit-appearance: none; appearance: none; }
        
        .freighter-status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .freighter-status.ready {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .freighter-status.error {
            background-color: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fca5a5;
        }
        
        .freighter-status.loading {
            background-color: #dbeafe;
            color: #0c2340;
            border: 1px solid #93c5fd;
        }
        
        .brave-notice {
            background-color: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        @supports (-webkit-appearance: none) {
            /* Brave specific CSS */
            button:focus {
                outline: 2px solid #3b82f6;
                outline-offset: 2px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script>
        // FREIGHTER CONNECTION - BRAVE BROWSER OPTIMIZED
        console.log('ðŸš€ App loading...');
        console.log('ðŸ“ Current URL:', window.location.href);
        console.log('ðŸŒ Browser:', navigator.userAgent);
        
        // Brave-specific: Check if running in Brave
        const isBrave = navigator.brave !== undefined || /brave/i.test(navigator.userAgent);
        console.log('ðŸ”— Is Brave Browser?', isBrave);
        
        if (isBrave) {
            console.log('ðŸš¨ BRAVE DETECTED - Applying Brave-specific fixes');
            console.log('ðŸ’¡ Brave requires explicit extension permissions');
        }
        
        console.log('ðŸ” Checking for Freighter...');
        
        // Check all possible injection points
        console.log('   window.freighter:', typeof window.freighter);
        console.log('   window.freighterApi:', typeof window.freighterApi);
        console.log('   window.stellar:', typeof window.stellar);
        console.log('   window.__STELLAR__:', typeof window.__STELLAR__);
        
        const waitForFreighter = () => {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = isBrave ? 1000 : 600; // Brave needs more time (100 seconds vs 60)
                
                const checkFreighter = () => {
                    // Try all possible injection points in order of preference
                    let api = null;
                    
                    // Primary: window.freighter (current standard)
                    if (window.freighter && typeof window.freighter.getPublicKey === 'function') {
                        api = window.freighter;
                        console.log('âœ… Using window.freighter');
                    }
                    // Secondary: window.freighterApi (legacy)
                    else if (window.freighterApi && typeof window.freighterApi.getPublicKey === 'function') {
                        api = window.freighterApi;
                        console.log('âœ… Using window.freighterApi');
                    }
                    // Tertiary: window.stellar (alternative)
                    else if (window.stellar && typeof window.stellar.getPublicKey === 'function') {
                        api = window.stellar;
                        console.log('âœ… Using window.stellar');
                    }
                    // Quaternary: window.__STELLAR__ (fallback)
                    else if (window.__STELLAR__ && typeof window.__STELLAR__.getPublicKey === 'function') {
                        api = window.__STELLAR__;
                        console.log('âœ… Using window.__STELLAR__');
                    }
                    
                    if (api) {
                        console.log('âœ…âœ… Freighter API found at attempt', attempts, '(' + (attempts * 100) + 'ms)');
                        console.log('ï¿½ API object keys:', Object.keys(api));
                        resolve(api);
                        return;
                    }
                    
                    attempts++;
                    const timeMs = attempts * 100;
                    const timeSec = (timeMs / 1000).toFixed(1);
                    const percent = Math.round((attempts / maxAttempts) * 100);
                    
                    if (attempts < maxAttempts) {
                        if (attempts === 1 || attempts % 50 === 0 || percent % 20 === 0) {
                            console.log(`â³ Waiting (${timeSec}s / ${(maxAttempts * 100 / 1000).toFixed(1)}s max) - ${percent}%`);
                        }
                        
                        // For Brave: Use longer delays initially, then shorter
                        const delay = isBrave && attempts < 100 ? 100 : 50;
                        setTimeout(checkFreighter, delay);
                    } else {
                        console.error('âŒ Freighter not found after ' + (maxAttempts * 100 / 1000) + ' seconds');
                        
                        const allProps = Object.keys(window);
                        const walletProps = allProps.filter(k => 
                            k.toLowerCase().includes('freighter') || 
                            k.toLowerCase().includes('stellar') ||
                            k.toLowerCase().includes('wallet') ||
                            k.toLowerCase().includes('eth') ||
                            k.toLowerCase().includes('solana')
                        );
                        console.error('ðŸ” Wallet-related window properties found:', walletProps);
                        
                        if (walletProps.length === 0) {
                            console.error('âš ï¸ No wallet extensions detected at all!');
                        }
                        
                        // For Brave specific troubleshooting
                        console.log('\nðŸ’¡ BRAVE TROUBLESHOOTING STEPS:');
                        console.log('   1. âœ… Confirm: Is Freighter extension installed?');
                        console.log('   2. âœ… Check: Extensions â†’ Freighter â†’ Is it ENABLED? (not grayed out)');
                        console.log('   3. âœ… Permissions: Click Freighter â†’ "Manage extension"');
                        console.log('   4. âœ… Set "Allow on all sites" or add localhost:3000');
                        console.log('   5. âœ… Refresh: Ctrl+R or Cmd+R');
                        console.log('   6. âœ… Last resort: Restart Brave completely');
                        
                        resolve(null);
                    }
                };
                
                // For Brave: Add initial delay before first check
                if (isBrave) {
                    setTimeout(checkFreighter, 200);
                } else {
                    checkFreighter();
                }
            });
        };

        const { useState, useEffect } = React;
        const e = React.createElement;

        function App() {
            const [freighter, setFreighter] = useState(null);
            const [account, setAccount] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [status, setStatus] = useState('Checking for Freighter...');
            const [manualAddress, setManualAddress] = useState('');

            useEffect(() => {
                const init = async () => {
                    const api = await waitForFreighter();
                    if (api) {
                        setFreighter(api);
                        setStatus('âœ… Freighter ready');
                    } else {
                        setError('WALLET_NOT_INSTALLED');
                        setStatus('âŒ Freighter not found');
                    }
                };
                init();
            }, []);

            const connect = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    console.log('ðŸ”Œ Connect button clicked');
                    console.log('ðŸŒ Is Brave Browser?', isBrave);
                    
                    if (!freighter) {
                        console.error('âŒ Freighter API not available');
                        setError('WALLET_NOT_INSTALLED');
                        setStatus('âŒ Install Freighter from freighter.app');
                        setLoading(false);
                        return;
                    }
                    
                    console.log('ðŸ“² Freighter available, attempting connection...');
                    console.log('ðŸ“¦ Freighter object keys:', Object.keys(freighter));
                    
                    // Check if Freighter is connected/unlocked
                    if (freighter.isConnected === false) {
                        console.warn('âš ï¸ Freighter wallet appears to be locked');
                        setStatus('âš ï¸ Unlock Freighter wallet in extension');
                    }
                    
                    let address = null;
                    let lastError = null;
                    
                    // Try getPublicKey (primary, modern Freighter)
                    if (typeof freighter.getPublicKey === 'function') {
                        try {
                            console.log('1ï¸âƒ£ Calling getPublicKey()...');
                            address = await freighter.getPublicKey();
                            console.log('âœ… SUCCESS via getPublicKey:', address);
                        } catch (err) {
                            lastError = err;
                            console.error('âŒ getPublicKey failed:', err.message);
                            console.error('   Error name:', err.name);
                            console.error('   Error code:', err.code);
                            
                            // Brave-specific errors
                            if (err.message.includes('User denied') || err.message.includes('denied')) {
                                console.log('ðŸ’¡ User denied permission - click Connect in Freighter popup');
                            }
                            if (err.message.includes('Timeou')) {
                                console.log('ðŸ’¡ Timeout - Freighter may be unresponsive. Try restarting Brave');
                            }
                        }
                    }
                    
                    // Try getAddress (secondary)
                    if (!address && typeof freighter.getAddress === 'function') {
                        try {
                            console.log('2ï¸âƒ£ Falling back to getAddress()...');
                            address = await freighter.getAddress();
                            console.log('âœ… SUCCESS via getAddress:', address);
                        } catch (err) {
                            lastError = err;
                            console.error('âŒ getAddress failed:', err.message);
                        }
                    }
                    
                    // Try requestPublicKey (tertiary, older API)
                    if (!address && typeof freighter.requestPublicKey === 'function') {
                        try {
                            console.log('3ï¸âƒ£ Falling back to requestPublicKey()...');
                            address = await freighter.requestPublicKey();
                            console.log('âœ… SUCCESS via requestPublicKey:', address);
                        } catch (err) {
                            lastError = err;
                            console.error('âŒ requestPublicKey failed:', err.message);
                        }
                    }
                    
                    if (!address) {
                        const errorMsg = lastError 
                            ? lastError.message 
                            : 'All connection methods failed. Freighter may be locked or not on Testnet.';
                        throw new Error(errorMsg);
                    }
                    
                    console.log('âœ…âœ… CONNECTED SUCCESSFULLY:', address);
                    setAccount(address);
                    setError(null);
                    setStatus('âœ… Connected: ' + address.substring(0, 15) + '...');
                } catch (err) {
                    console.error('âŒ Connection failed:', err.message);
                    console.error('   Full error:', err);
                    
                    // Brave-specific error messages
                    let userMessage = err.message;
                    if (err.message.includes('locked')) {
                        userMessage = 'Freighter wallet is locked - unlock in extension first';
                    }
                    if (err.message.includes('Testnet')) {
                        userMessage = 'Freighter network set to wrong network - switch to Testnet';
                    }
                    
                    setError(userMessage);
                    setStatus('âŒ ' + userMessage);
                } finally {
                    setLoading(false);
                }
            };

            const connectManually = () => {
                if (!manualAddress || manualAddress.trim().length === 0) {
                    setError('Please enter a valid wallet address');
                    return;
                }
                if (!manualAddress.startsWith('G')) {
                    setError('Stellar addresses start with "G"');
                    return;
                }
                console.log('âœ… Manual connection:', manualAddress);
                setAccount(manualAddress);
                setError(null);
                setStatus('âœ… Connected: ' + manualAddress.substring(0, 15) + '...');
            };
                return e('div', { className: 'min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center p-4' },
                    e('div', { className: 'bg-white rounded-lg shadow-xl p-8 text-center max-w-md' },
                        e('h1', { className: 'text-4xl mb-4' }, 'ðŸ”'),
                        e('h2', { className: 'text-3xl font-bold text-gray-800 mb-4' }, 'Stellar Insurance'),
                        e('p', { className: 'text-gray-600 mb-6' }, 'Decentralized Insurance'),
                        
                        // Brave-specific notice
                        isBrave && e('div', { className: 'brave-notice' },
                            e('p', { className: 'font-bold mb-2' }, 'ðŸ¦ Brave Browser Detected'),
                            e('p', null, 'Freighter may need permission setup. See instructions below.')
                        ),
                        
                        // Status indicator
                        e('div', { className: 'freighter-status ' + (freighter ? 'ready' : error ? 'error' : 'loading') },
                            freighter 
                                ? 'âœ… Freighter Ready - Click Connect'
                                : error ? 'âŒ ' + status
                                : 'â³ Loading Freighter... (checking browser)'
                        ),
                        
                        error === 'WALLET_NOT_INSTALLED' && e('div', { className: 'bg-yellow-100 border-2 border-yellow-400 text-yellow-800 px-4 py-4 rounded mb-6' },
                            e('p', { className: 'font-bold mb-2' }, 'ðŸ“¥ Freighter Not Installed'),
                            e('p', { className: 'mb-3 text-sm' }, isBrave 
                                ? 'Brave users: After installing, go to Settings â†’ Extensions â†’ Freighter â†’ Allow on all sites'
                                : 'Install Freighter to continue'
                            ),
                            e('a', {
                                href: 'https://www.freighter.app/',
                                target: '_blank',
                                className: 'inline-block w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded font-semibold mt-2'
                            }, 'ðŸ”— Download Freighter')
                        ),
                        
                        error && error !== 'WALLET_NOT_INSTALLED' && e('div', { className: 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4' },
                            e('p', { className: 'font-bold mb-1' }, 'âŒ Connection Error'),
                            e('p', { className: 'text-sm mb-2' }, error),
                            isBrave && e('div', { className: 'mt-3 p-2 bg-red-50 rounded text-xs text-left' },
                                e('p', { className: 'font-bold mb-1' }, 'For Brave:'),
                                e('ul', { className: 'list-disc list-inside space-y-1' },
                                    e('li', null, 'Unlock Freighter wallet in extension'),
                                    e('li', null, 'Check network is set to Testnet'),
                                    e('li', null, 'Try: Ctrl+Shift+Delete to restart Brave'),
                                    e('li', null, 'Open DevTools (F12) to see detailed errors')
                                )
                            )
                        ),
                        
                        e('button', {
                            onClick: connect,
                            disabled: loading || !freighter,
                            className: 'w-full py-3 rounded-lg font-semibold text-white ' + 
                                (freighter && !loading ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400')
                        }, loading ? 'â³ Connecting...' : 'ðŸ”— Connect Freighter'),
                        
                        // Manual wallet address input (workaround for Freighter issues)
                        e('div', { className: 'mt-6 pt-6 border-t border-gray-300' },
                            e('p', { className: 'text-sm font-bold text-gray-700 mb-3' }, 'ðŸ”„ Manual Wallet Address (Brave Workaround)'),
                            e('input', {
                                type: 'text',
                                placeholder: 'Enter Stellar address (G...)',
                                value: manualAddress,
                                onChange: (evt) => setManualAddress(evt.target.value),
                                className: 'w-full px-4 py-2 border border-gray-300 rounded mb-2 text-sm focus:outline-none focus:border-blue-500',
                            }),
                            e('button', {
                                onClick: connectManually,
                                className: 'w-full py-2 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 text-sm'
                            }, 'âœ… Connect with Address'),
                            e('p', { className: 'text-xs text-gray-600 mt-2' }, 'ðŸ’¡ Paste your Stellar testnet address to test the app without Freighter')
                        ),
                        
                        e('p', { className: 'text-xs text-gray-600 mt-3' }, status)
                    )
                );
            }

            return e('div', { className: 'min-h-screen bg-gray-100' },
                e('div', { className: 'max-w-7xl mx-auto p-8' },
                    e('div', { className: 'bg-white rounded-lg shadow p-6' },
                        e('h2', { className: 'text-2xl font-bold mb-4' }, 'âœ… Connected!'),
                        e('p', { className: 'text-gray-600 mb-4' }, account),
                        e('button', {
                            onClick: () => setAccount(null),
                            className: 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded'
                        }, 'ðŸšª Disconnect')
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
</body>
</html>
