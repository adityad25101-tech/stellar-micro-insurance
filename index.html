<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Micro Insurance</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        console.log('üìÑ Page loading...');
        console.log('React version check:', typeof window.React !== 'undefined' ? 'OK' : 'PENDING');
        console.log('ReactDOM version check:', typeof window.ReactDOM !== 'undefined' ? 'OK' : 'PENDING');
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
        
        /* Brave-specific fixes */
        button { -webkit-appearance: none; appearance: none; }
        input { -webkit-appearance: none; appearance: none; }
        
        .freighter-status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .freighter-status.ready {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .freighter-status.error {
            background-color: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fca5a5;
        }
        
        .freighter-status.loading {
            background-color: #dbeafe;
            color: #0c2340;
            border: 1px solid #93c5fd;
        }
        
        .brave-notice {
            background-color: #fef3c7;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            line-height: 1.5;
        }
        
        @supports (-webkit-appearance: none) {
            /* Brave specific CSS */
            button:focus {
                outline: 2px solid #3b82f6;
                outline-offset: 2px;
            }
        }
    </style>
</head>
<body>
    <div id="root" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #f3f4f6;">
        <div style="text-align: center; padding: 20px;">
            <h1 style="font-size: 24px; margin-bottom: 10px;">‚è≥ Loading Stellar Insurance...</h1>
            <p style="color: #666; font-size: 14px;">Please wait while the application initializes</p>
        </div>
    </div>
    
    <script>
        // FREIGHTER CONNECTION - BRAVE BROWSER OPTIMIZED
        console.log('üöÄ App loading...');
        console.log('üìç Current URL:', window.location.href);
        console.log('üåê Browser:', navigator.userAgent);
        
        // Brave-specific: Check if running in Brave
        const isBrave = navigator.brave !== undefined || /brave/i.test(navigator.userAgent);
        console.log('üîó Is Brave Browser?', isBrave);
        
        if (isBrave) {
            console.log('üö® BRAVE DETECTED - Applying Brave-specific fixes');
            console.log('üí° Brave requires explicit extension permissions');
        }
        
        console.log('üîç Checking for Freighter...');
        
        // Check all possible injection points
        console.log('   window.freighter:', typeof window.freighter);
        console.log('   window.freighterApi:', typeof window.freighterApi);
        console.log('   window.stellar:', typeof window.stellar);
        console.log('   window.__STELLAR__:', typeof window.__STELLAR__);
        
        const waitForFreighter = () => {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = isBrave ? 1000 : 600; // Brave needs more time (100 seconds vs 60)
                
                const checkFreighter = () => {
                    // Try all possible injection points in order of preference
                    let api = null;
                    
                    // Primary: window.freighter (current standard)
                    if (window.freighter && typeof window.freighter.getPublicKey === 'function') {
                        api = window.freighter;
                        console.log('‚úÖ Using window.freighter');
                    }
                    // Secondary: window.freighterApi (legacy)
                    else if (window.freighterApi && typeof window.freighterApi.getPublicKey === 'function') {
                        api = window.freighterApi;
                        console.log('‚úÖ Using window.freighterApi');
                    }
                    // Tertiary: window.stellar (alternative)
                    else if (window.stellar && typeof window.stellar.getPublicKey === 'function') {
                        api = window.stellar;
                        console.log('‚úÖ Using window.stellar');
                    }
                    // Quaternary: window.__STELLAR__ (fallback)
                    else if (window.__STELLAR__ && typeof window.__STELLAR__.getPublicKey === 'function') {
                        api = window.__STELLAR__;
                        console.log('‚úÖ Using window.__STELLAR__');
                    }
                    
                    if (api) {
                        console.log('‚úÖ‚úÖ Freighter API found at attempt', attempts, '(' + (attempts * 100) + 'ms)');
                        console.log('ÔøΩ API object keys:', Object.keys(api));
                        resolve(api);
                        return;
                    }
                    
                    attempts++;
                    const timeMs = attempts * 100;
                    const timeSec = (timeMs / 1000).toFixed(1);
                    const percent = Math.round((attempts / maxAttempts) * 100);
                    
                    if (attempts < maxAttempts) {
                        if (attempts === 1 || attempts % 50 === 0 || percent % 20 === 0) {
                            console.log(`‚è≥ Waiting (${timeSec}s / ${(maxAttempts * 100 / 1000).toFixed(1)}s max) - ${percent}%`);
                        }
                        
                        // For Brave: Use longer delays initially, then shorter
                        const delay = isBrave && attempts < 100 ? 100 : 50;
                        setTimeout(checkFreighter, delay);
                    } else {
                        console.error('‚ùå Freighter not found after ' + (maxAttempts * 100 / 1000) + ' seconds');
                        
                        const allProps = Object.keys(window);
                        const walletProps = allProps.filter(k => 
                            k.toLowerCase().includes('freighter') || 
                            k.toLowerCase().includes('stellar') ||
                            k.toLowerCase().includes('wallet') ||
                            k.toLowerCase().includes('eth') ||
                            k.toLowerCase().includes('solana')
                        );
                        console.error('üîç Wallet-related window properties found:', walletProps);
                        
                        if (walletProps.length === 0) {
                            console.error('‚ö†Ô∏è No wallet extensions detected at all!');
                        }
                        
                        // For Brave specific troubleshooting
                        console.log('\nüí° BRAVE TROUBLESHOOTING STEPS:');
                        console.log('   1. ‚úÖ Confirm: Is Freighter extension installed?');
                        console.log('   2. ‚úÖ Check: Extensions ‚Üí Freighter ‚Üí Is it ENABLED? (not grayed out)');
                        console.log('   3. ‚úÖ Permissions: Click Freighter ‚Üí "Manage extension"');
                        console.log('   4. ‚úÖ Set "Allow on all sites" or add localhost:3000');
                        console.log('   5. ‚úÖ Refresh: Ctrl+R or Cmd+R');
                        console.log('   6. ‚úÖ Last resort: Restart Brave completely');
                        
                        resolve(null);
                    }
                };
                
                // For Brave: Add initial delay before first check
                if (isBrave) {
                    setTimeout(checkFreighter, 200);
                } else {
                    checkFreighter();
                }
            });
        };

        const { useState, useEffect } = React;
        const e = React.createElement;

        function App() {
            const [freighter, setFreighter] = useState(null);
            const [account, setAccount] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [status, setStatus] = useState('Checking for Freighter...');
            const [manualAddress, setManualAddress] = useState('');

            useEffect(() => {
                const init = async () => {
                    const api = await waitForFreighter();
                    if (api) {
                        setFreighter(api);
                        setStatus('‚úÖ Freighter ready');
                    } else {
                        setError('WALLET_NOT_INSTALLED');
                        setStatus('‚ùå Freighter not found');
                    }
                };
                init();
            }, []);

            const connect = async () => {
                try {
                    setLoading(true);
                    setError(null);
                    console.log('üîå Connect button clicked');
                    console.log('üåê Is Brave Browser?', isBrave);
                    
                    if (!freighter) {
                        console.error('‚ùå Freighter API not available');
                        setError('WALLET_NOT_INSTALLED');
                        setStatus('‚ùå Install Freighter from freighter.app');
                        setLoading(false);
                        return;
                    }
                    
                    console.log('üì≤ Freighter available, attempting connection...');
                    console.log('üì¶ Freighter object keys:', Object.keys(freighter));
                    
                    // Check if Freighter is connected/unlocked
                    if (freighter.isConnected === false) {
                        console.warn('‚ö†Ô∏è Freighter wallet appears to be locked');
                        setStatus('‚ö†Ô∏è Unlock Freighter wallet in extension');
                    }
                    
                    let address = null;
                    let lastError = null;
                    
                    // Try getPublicKey (primary, modern Freighter)
                    if (typeof freighter.getPublicKey === 'function') {
                        try {
                            console.log('1Ô∏è‚É£ Calling getPublicKey()...');
                            address = await freighter.getPublicKey();
                            console.log('‚úÖ SUCCESS via getPublicKey:', address);
                        } catch (err) {
                            lastError = err;
                            console.error('‚ùå getPublicKey failed:', err.message);
                            console.error('   Error name:', err.name);
                            console.error('   Error code:', err.code);
                            
                            // Brave-specific errors
                            if (err.message.includes('User denied') || err.message.includes('denied')) {
                                console.log('üí° User denied permission - click Connect in Freighter popup');
                            }
                            if (err.message.includes('Timeou')) {
                                console.log('üí° Timeout - Freighter may be unresponsive. Try restarting Brave');
                            }
                        }
                    }
                    
                    // Try getAddress (secondary)
                    if (!address && typeof freighter.getAddress === 'function') {
                        try {
                            console.log('2Ô∏è‚É£ Falling back to getAddress()...');
                            address = await freighter.getAddress();
                            console.log('‚úÖ SUCCESS via getAddress:', address);
                        } catch (err) {
                            lastError = err;
                            console.error('‚ùå getAddress failed:', err.message);
                        }
                    }
                    
                    // Try requestPublicKey (tertiary, older API)
                    if (!address && typeof freighter.requestPublicKey === 'function') {
                        try {
                            console.log('3Ô∏è‚É£ Falling back to requestPublicKey()...');
                            address = await freighter.requestPublicKey();
                            console.log('‚úÖ SUCCESS via requestPublicKey:', address);
                        } catch (err) {
                            lastError = err;
                            console.error('‚ùå requestPublicKey failed:', err.message);
                        }
                    }
                    
                    if (!address) {
                        const errorMsg = lastError 
                            ? lastError.message 
                            : 'All connection methods failed. Freighter may be locked or not on Testnet.';
                        throw new Error(errorMsg);
                    }
                    
                    console.log('‚úÖ‚úÖ CONNECTED SUCCESSFULLY:', address);
                    setAccount(address);
                    setError(null);
                    setStatus('‚úÖ Connected: ' + address.substring(0, 15) + '...');
                } catch (err) {
                    console.error('‚ùå Connection failed:', err.message);
                    console.error('   Full error:', err);
                    
                    // Brave-specific error messages
                    let userMessage = err.message;
                    if (err.message.includes('locked')) {
                        userMessage = 'Freighter wallet is locked - unlock in extension first';
                    }
                    if (err.message.includes('Testnet')) {
                        userMessage = 'Freighter network set to wrong network - switch to Testnet';
                    }
                    
                    setError(userMessage);
                    setStatus('‚ùå ' + userMessage);
                } finally {
                    setLoading(false);
                }
            };

            const connectManually = () => {
                if (!manualAddress || manualAddress.trim().length === 0) {
                    setError('Please enter a valid wallet address');
                    return;
                }
                if (!manualAddress.startsWith('G')) {
                    setError('Stellar addresses start with "G"');
                    return;
                }
                console.log('‚úÖ Manual connection:', manualAddress);
                setAccount(manualAddress);
                setError(null);
                setStatus('‚úÖ Connected: ' + manualAddress.substring(0, 15) + '...');
            };
                return e('div', { className: 'min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center p-4' },
                    e('div', { className: 'bg-white rounded-lg shadow-xl p-8 text-center max-w-md' },
                        e('h1', { className: 'text-4xl mb-4' }, 'üîê'),
                        e('h2', { className: 'text-3xl font-bold text-gray-800 mb-4' }, 'Stellar Insurance'),
                        e('p', { className: 'text-gray-600 mb-6' }, 'Decentralized Insurance'),
                        
                        // Brave-specific notice
                        isBrave && e('div', { className: 'brave-notice' },
                            e('p', { className: 'font-bold mb-2' }, 'ü¶Å Brave Browser Detected'),
                            e('p', null, 'Freighter may need permission setup. See instructions below.')
                        ),
                        
                        // Status indicator
                        e('div', { className: 'freighter-status ' + (freighter ? 'ready' : error ? 'error' : 'loading') },
                            freighter 
                                ? '‚úÖ Freighter Ready - Click Connect'
                                : error ? '‚ùå ' + status
                                : '‚è≥ Loading Freighter... (checking browser)'
                        ),
                        
                        error === 'WALLET_NOT_INSTALLED' && e('div', { className: 'bg-yellow-100 border-2 border-yellow-400 text-yellow-800 px-4 py-4 rounded mb-6' },
                            e('p', { className: 'font-bold mb-2' }, 'üì• Freighter Not Installed'),
                            e('p', { className: 'mb-3 text-sm' }, isBrave 
                                ? 'Brave users: After installing, go to Settings ‚Üí Extensions ‚Üí Freighter ‚Üí Allow on all sites'
                                : 'Install Freighter to continue'
                            ),
                            e('a', {
                                href: 'https://www.freighter.app/',
                                target: '_blank',
                                className: 'inline-block w-full bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-4 rounded font-semibold mt-2'
                            }, 'üîó Download Freighter')
                        ),
                        
                        error && error !== 'WALLET_NOT_INSTALLED' && e('div', { className: 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4' },
                            e('p', { className: 'font-bold mb-1' }, '‚ùå Connection Error'),
                            e('p', { className: 'text-sm mb-2' }, error),
                            isBrave && e('div', { className: 'mt-3 p-2 bg-red-50 rounded text-xs text-left' },
                                e('p', { className: 'font-bold mb-1' }, 'For Brave:'),
                                e('ul', { className: 'list-disc list-inside space-y-1' },
                                    e('li', null, 'Unlock Freighter wallet in extension'),
                                    e('li', null, 'Check network is set to Testnet'),
                                    e('li', null, 'Try: Ctrl+Shift+Delete to restart Brave'),
                                    e('li', null, 'Open DevTools (F12) to see detailed errors')
                                )
                            )
                        ),
                        
                        e('button', {
                            onClick: connect,
                            disabled: loading || !freighter,
                            className: 'w-full py-3 rounded-lg font-semibold text-white ' + 
                                (freighter && !loading ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400')
                        }, loading ? '‚è≥ Connecting...' : 'üîó Connect Freighter'),
                        
                        // Manual wallet address input (workaround for Freighter issues)
                        e('div', { className: 'mt-6 pt-6 border-t border-gray-300' },
                            e('p', { className: 'text-sm font-bold text-gray-700 mb-3' }, 'üîÑ Manual Wallet Address (Brave Workaround)'),
                            e('input', {
                                type: 'text',
                                placeholder: 'Enter Stellar address (G...)',
                                value: manualAddress,
                                onChange: (evt) => setManualAddress(evt.target.value),
                                className: 'w-full px-4 py-2 border border-gray-300 rounded mb-2 text-sm focus:outline-none focus:border-blue-500',
                            }),
                            e('button', {
                                onClick: connectManually,
                                className: 'w-full py-2 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 text-sm'
                            }, '‚úÖ Connect with Address'),
                            e('p', { className: 'text-xs text-gray-600 mt-2' }, 'üí° Paste your Stellar testnet address to test the app without Freighter')
                        ),
                        
                        e('p', { className: 'text-xs text-gray-600 mt-3' }, status)
                    )
                );
            }

            return e('div', { className: 'min-h-screen bg-gray-100' },
                e('div', { className: 'max-w-7xl mx-auto p-8' },
                    e('div', { className: 'bg-white rounded-lg shadow p-6' },
                        e('h2', { className: 'text-2xl font-bold mb-4' }, '‚úÖ Connected!'),
                        e('p', { className: 'text-gray-600 mb-4' }, account),
                        e('button', {
                            onClick: () => setAccount(null),
                            className: 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded'
                        }, 'üö™ Disconnect')
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
    <script>
        // Error handler
        window.addEventListener('error', (event) => {
            console.error('üî¥ JavaScript Error:', event.error);
            console.error('Message:', event.message);
            console.error('Stack:', event.error?.stack);
            document.getElementById('root').innerHTML = `
                <div style="padding: 20px; color: red; font-family: monospace;">
                    <h2>‚ùå Error Loading App</h2>
                    <p>${event.message}</p>
                    <p style="color: #666; font-size: 12px;">Check DevTools console (F12) for details</p>
                </div>
            `;
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('üî¥ Unhandled Promise Rejection:', event.reason);
        });
    </script>
</body>
</html>
